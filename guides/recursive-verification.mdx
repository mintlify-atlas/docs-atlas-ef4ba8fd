---
title: Recursive Verification
description: Recursively verify ProveKit proofs using Gnark for enhanced composability
---

Recursive verification allows you to verify a WHIR proof inside another zero-knowledge proof system. ProveKit integrates with Gnark to enable recursive verification of proofs, which is essential for proof aggregation and blockchain applications.

## What is Recursive Verification?

Recursive verification is the process of verifying a zero-knowledge proof (the "inner proof") inside another zero-knowledge proof system (the "outer proof"). This enables:

- **Proof Aggregation** - Combine multiple proofs into a single proof
- **Blockchain Compatibility** - Verify WHIR proofs in EVM-compatible systems
- **Composability** - Build complex proof systems from simpler components

ProveKit's recursive verifier uses [Gnark](https://github.com/Consensys/gnark) with the BN254 curve to verify WHIR proofs generated by ProveKit.

## Architecture

The recursive verification flow:

```
ProveKit Proof (.np) → Generate Gnark Inputs → Gnark Circuit → Gnark Proof
```

1. Generate a proof using ProveKit's prover
2. Extract verification parameters for Gnark
3. Run the Gnark recursive verifier circuit
4. Generate a Gnark proof of successful verification

## Prerequisites

- ProveKit proof generated (`.np` file)
- Prover key package (`.pkp` file)
- Go installed (for Gnark)
- `recursive-verifier` directory from ProveKit repository

## Workflow

<Steps>
  <Step title="Prepare Your Proof">
    First, generate a ProveKit proof following the [Proving Workflow](/guides/proving-workflow):

    ```bash
    cd noir-examples/poseidon-rounds
    nargo compile
    
    cargo run --release --bin provekit-cli prepare \
      ./target/basic.json \
      --pkp ./prover.pkp \
      --pkv ./verifier.pkv
    
    cargo run --release --bin provekit-cli prove \
      ./prover.pkp \
      ./Prover.toml \
      -o ./proof.np
    ```
  </Step>

  <Step title="Generate Gnark Inputs">
    Extract the verification parameters needed for the Gnark circuit:

    ```bash
    cargo run --release --bin provekit-cli generate-gnark-inputs \
      ./prover.pkp \
      ./proof.np
    ```

    This generates:
    - `params_for_recursive_verifier` - Configuration for the Gnark verifier circuit
    - `r1cs.json` - R1CS constraint system of the inner circuit
  </Step>

  <Step title="Run the Recursive Verifier">
    Navigate to the `recursive-verifier` directory and run the Gnark verifier:

    ```bash
    cd recursive-verifier
    go run cmd/cli/main.go \
      --config ../noir-examples/poseidon-rounds/params_for_recursive_verifier \
      --r1cs ../noir-examples/poseidon-rounds/r1cs.json
    ```

    The verifier will:
    1. Load the WHIR proof parameters
    2. Construct a Gnark circuit that verifies the WHIR proof
    3. Generate a Gnark proof of successful verification
    4. Verify the Gnark proof
  </Step>
</Steps>

## CLI Flags

The recursive verifier CLI supports the following flags:

| Flag | Description | Default |
|------|-------------|----------|
| `--config` | Path to JSON configuration file with verifier circuit parameters | `../noir-examples/poseidon-rounds/params_for_recursive_verifier` |
| `--r1cs` | Path to R1CS JSON file of the inner circuit | `../noir-examples/poseidon-rounds/r1cs.json` |
| `--ccs` | Optional path to serialize the constraint system | (not serialized) |
| `--pk` | Optional path to load Proving Key (PK) | (generated unsafely) |
| `--vk` | Optional path to load Verifying Key (VK) | (generated unsafely) |

<Warning>
By default, the PK and VK are generated unsafely. For production use, you should use a trusted setup and provide pre-generated keys via `--pk` and `--vk` flags.
</Warning>

## HTTP Server

The recursive verifier also provides an HTTP API for remote verification:

### Starting the Server

```bash
cd recursive-verifier
go run cmd/server/main.go
```

The server runs on `http://localhost:3000` with:
- Read Timeout: 10 minutes
- Write Timeout: 5 minutes
- Body Limit: 2GB
- CORS: Enabled

### API Endpoints

#### Health Check

```bash
curl http://localhost:3000/api/v1/ping
```

#### Verify Proof

```bash
curl -X POST \
  -F "config=@params_for_recursive_verifier" \
  -F "r1cs=@r1cs.json" \
  http://localhost:3000/api/v1/verify
```

**Optional parameters:**
- `r1cs_url` - URL to download R1CS file (takes precedence over uploaded file)
- `pk_url` - URL to download proving key
- `vk_url` - URL to download verifying key

**Response:**
- `200` - Verification successful
- `400` - Bad request or verification failed
- `500` - Internal server error

## Understanding the Gnark Circuit

The recursive verifier implements the WHIR verification algorithm inside a Gnark circuit. Key components include:

### Circuit Files

Located in `recursive-verifier/app/circuit/`:

- `circuit.go` - Main Gnark circuit definition
- `whir.go` - WHIR verification logic
- `mt.go` - Merkle tree operations
- `matrix_evaluation.go` - R1CS matrix evaluation
- `keccakSponge/` - Keccak hash function implementation

### Type Converters

The `typeConverters/` directory handles conversion between:
- ProveKit's native types (M31/CM31 field elements)
- Gnark's BN254 field elements

## Advanced Usage

### Saving Constraint System

Serialize the Gnark constraint system for reuse:

```bash
go run cmd/cli/main.go \
  --config ../noir-examples/poseidon-rounds/params_for_recursive_verifier \
  --r1cs ../noir-examples/poseidon-rounds/r1cs.json \
  --ccs ./constraint_system.ccs
```

### Using Pre-generated Keys

For production, generate keys once and reuse them:

```bash
go run cmd/cli/main.go \
  --config params_for_recursive_verifier \
  --r1cs r1cs.json \
  --pk ./proving_key.pk \
  --vk ./verifying_key.vk
```

### Docker Deployment

The recursive verifier includes Docker support:

```bash
cd recursive-verifier
docker-compose up
```

This starts the HTTP server in a containerized environment.

## Example: Complete Recursive Workflow

Here's a full example using the `poseidon-rounds` circuit:

```bash
# Step 1: Generate ProveKit proof
cd noir-examples/poseidon-rounds
nargo compile

cargo run --release --bin provekit-cli prepare \
  ./target/basic.json \
  --pkp ./prover.pkp \
  --pkv ./verifier.pkv

cargo run --release --bin provekit-cli prove \
  ./prover.pkp \
  ./Prover.toml \
  -o ./proof.np

cargo run --release --bin provekit-cli verify \
  ./verifier.pkv \
  ./proof.np

# Step 2: Generate Gnark inputs
cargo run --release --bin provekit-cli generate-gnark-inputs \
  ./prover.pkp \
  ./proof.np

# Step 3: Run recursive verifier
cd ../../recursive-verifier
go run cmd/cli/main.go \
  --config ../noir-examples/poseidon-rounds/params_for_recursive_verifier \
  --r1cs ../noir-examples/poseidon-rounds/r1cs.json
```

## Dependencies

The recursive verifier depends on:

- [gnark](https://github.com/Consensys/gnark) - Gnark ZKP library
- [gnark-skyscraper](https://github.com/reilabs/gnark-skyscraper) - Field arithmetic for M31/CM31
- [gnark-crypto](https://github.com/Consensys/gnark-crypto) - Cryptographic primitives

See `recursive-verifier/go.mod` for the complete dependency list.

## Next Steps

- Learn how to [Benchmark](/guides/benchmarking) recursive verification performance
- Explore the [Architecture](/concepts/architecture) of ProveKit's recursive verifier
- Check out [WHIR](https://eprint.iacr.org/2024/1586.pdf) for the underlying proof system
